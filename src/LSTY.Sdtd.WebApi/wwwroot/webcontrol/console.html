<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <!-- import CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        body {
            width: 100vw;
            height: 100vh;
            margin: 0;
        }

        #app {
            width: 100%;
            height: 100%;
        }

        #content {
            background: rgb(30, 30, 30);
            width: 100%;
            height: calc(100% - 60px);
            overflow: auto;
        }

        #content>p {
            margin: 0;
            word-wrap: break-word;
            word-break: break-all;
            font-size: 16px;
            white-space: pre-wrap;
        }
    </style>
</head>

<body>
    <div id="app">
        <div id="content"></div>
        <template>
            <div style="margin-top: 10px;">
                <div style="display: inline-block; width: calc(100% - 103px);">
                    <el-input placeholder="请输入内容" v-model="command" clearable @keyup.enter.native="sendCommand">
                    </el-input>
                </div>
                <el-button type="primary" @click="sendCommand">发送命令</el-button>
            </div>
        </template>
    </div>
</body>
<!-- import Vue before Element -->
<script src="https://unpkg.com/vue/dist/vue.min.js"></script>
<!-- import JavaScript -->
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script crossorigin src="https://unpkg.com/@msgpack/msgpack"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
<script src="/js/global.js"></script>
<script src="/js/api.js"></script>
<script>
    new Vue({
        el: "#app",
        data() {
            return {
                websocketPath: "ws://localhost:8089/ws",
                logCount: 0,
                logMaxCount: 1000,
                connection: null,
                command: '',
                timer: null,
            };
        },
        created() {
            this.initWebsocket();
        },
        methods: {
            initWebsocket() {
                this.outputLog('Connecting websocket server...', 3, true);
                var connection = new WebSocket(this.websocketPath);
                connection.binaryType = 'arraybuffer';
                connection.onopen = () => {
                    this.outputLog('Websocket connection started', 3, true);
                }
                connection.onmessage = (e) => {
                    const logEntry = MessagePack.decode(e.data);
                    //console.log(logEntry);
                    this.outputLog(logEntry.Message, logEntry.LogType);
                }
                connection.onclose = (e) => {
                    this.outputLog('Websocket connection closed, prepare to try reconnect', 3, true);
                    this.startTimer();
                }
                connection.onerror = (e) => {
                    //console.log(e);
                    this.outputLog('Error in websocket connection', 0, true);
                }

                this.connection = connection;
            },
            outputLog(message, logType = 3, addDatetime = false) {
                if (addDatetime) {
                    message = moment().format('YYYY-MM-DDTHH:mm:ss ') + message;
                }

                const element = document.getElementById('content');

                if (this.logCount > this.logMaxCount) {
                    element.removeChild(element.firstElementChild);
                }
                else {
                    ++this.logCount;
                }

                let color;
                switch (logType) {
                    // Error
                    case 0:
                        color = 'red';
                        break;
                    // Assert
                    case 1:
                        color = '#006400';
                        break;
                    // Warning
                    case 2:
                        color = 'yellow';
                        break;
                    // Log
                    case 3:
                        color = '#00C814';
                        break;
                    // Exception
                    case 4:
                        color = 'red';
                        break;
                    default:
                        color = '#00C814';
                }

                const p = document.createElement("p");
                p.innerHTML = `<font color="${color}">${message}</font>`;

                element.appendChild(p);
                p.scrollIntoView();
            },
            sendCommand() {
                api.sendConsoleCommand(this.command).then((response) => {
                    response.data.data.forEach(item => {
                        this.outputLog(item, 1);
                    });
                });
            },
            startTimer() {
                if (this.timer) {
                    clearTimeout(this.timer);
                }
                this.timer = setTimeout(this.initWebsocket, 5000); // 注意: 第一个参数为方法名的时候不要加括号;
            },
        },
        beforeDestroy() {
            clearTimeout(this.timer);
        },
    });
</script>

</html>